<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../d2l-dropdown/d2l-dropdown-menu.html">
<link rel="import" href="../d2l-dropdown/d2l-menu.html">
<link rel="import" href="../d2l-dropdown/d2l-menu-item.html">
<link rel="import" href="shared-styles.html">
<link rel="import" href="item-link-behavior.html">
<link rel="import" href="group-button.html">
<dom-module id="d2l-navigation-more-group">
	<style include="d2l-navigation-shared-styles">
		:host {
			@apply(--d2l-navigation-item);
		}
		:host-context([dir='rtl']) {
			@apply(--d2l-navigation-item-rtl);
		}
		:host-context([justify-content]) {
			margin-left: 0;
			margin-right: 0;
		}
		.d2l-navigation-item-group-menu {
			@apply(--d2l-navigation-item-dropdown);
		}
		d2l-dropdown-menu {
			width: 12.5rem;
		}
	</style>
	<template>
		<button is="d2l-navigation-group" on-tap="_handleOpenerTap">More</button> <!-- todo: needs to be localized -->
		<d2l-dropdown-menu>
			<d2l-menu>
				<template is="dom-repeat" items="{{items}}">
					 <d2l-menu-item text="{{getItemLinkText(item)}}" item="{{item}}" class="d2l-navigation-more-group-first-level">
						 <template is="dom-if" if="{{isItemGroup(item)}}">
							 <d2l-menu label="{{getItemLinkText(item)}}">
								 <template is="dom-repeat" items="{{item.entities}}">
									 <template is="dom-if" if="{{isItemLink(item)}}">
										 <d2l-menu-item
											 text="{{getItemLinkText(item)}}"
											 item="{{item}}"></d2l-menu-item>
									 </template>
								 </template>
							 </d2l-menu>
						 </template>
					 </d2l-menu-item>
				 </template>
			</d2l-menu>
		</d2l-dropdown-menu>
	</template>
</dom-module>
<script>
	Polymer({
		is: 'd2l-navigation-more-group',
		behaviors: [window.D2L.PolymerBehaviors.Navigation.ItemLinkBehavior],
		properties: {
			items: Array
		},
		hostAttributes: {
			role: 'listitem'
		},
		listeners: {
			'select': '_handleSelect'
		},
		showAndHideItems: function(startingIndex) {
			var items = Polymer.dom(this.root).querySelectorAll('d2l-menu-item.d2l-navigation-more-group-first-level');
			items.forEach(function(item, index) {
				if (index < startingIndex) {
					Polymer.dom(item).node.setAttribute('hidden', 'hidden');
				} else {
					Polymer.dom(item).node.removeAttribute('hidden');
				}
			});
		},
		_handleOpenerTap: function() {
			var opener = this.$$('button');
			var menu = this.$$('d2l-dropdown-menu');
			menu.open(opener);
		},
		_handleSelect: function(event) {
			var item = Polymer.dom(event).rootTarget.item;
			if (this.isItemLink(item)) {
				this.onItemLinkClick(item, true);
			}
		}
	});
</script>
