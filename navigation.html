<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../iron-ajax/iron-ajax.html">
<link rel="import" href="page-load-progress.html">
<link rel="import" href="navigation-resolved.html">
<dom-module id="d2l-navigation">
	<style>
		:host {
			background-color: #fff;
			display: block;
			line-height: 1;
			position: relative;
		}
		d2l-navigation-resolved {
			transition: opacity 200ms;
		}
		:host([loading]) d2l-navigation-resolved {
			opacity: 0;
		}
	</style>
	<template>
		<iron-ajax
			id="nav"
			url="{{endpoint}}"
			handle-as="json"
			last-response="{{response}}"
			on-response="handleNavResponse"></iron-ajax>
		<d2l-navigation-page-load-progress
			color="[[themeColor]]"></d2l-navigation-page-load-progress>
		<d2l-navigation-resolved
			logo-src="[[logoSrc]]"
			logo-href="[[logoHref]]"
			items="[[items]]"
			text="[[text]]"></d2l-navigation-resolved>
	</template>
</dom-module>
<script>
	Polymer({
		is: 'd2l-navigation',
		properties: {
			delay: {
				type: Number,
				value: 200
			},
			endpoint: String,
			logoSrc: String,
			logoHref: String,
			loading: {
				reflectToAttribute: true,
				type: Boolean,
				value: false
			},
			items: Array,
			response: Object,
			text: String,
			themeColor: String,
			themeRequest: Object
		},
		updateLoading: function() {
			if (this.themeRequest && this.themeRequest.status === 200 && !this.$.nav.loading) {
				var delay = Math.max(200, this.delay);
				this.async(function() {
					this.$$('d2l-navigation-page-load-progress').finish();
					this.fire('d2l-navigation-ready');
					this.loading = false;
				}.bind(this), delay);
			}
		},
		ready: function() {
			this.load();
		},
		handleNavResponse: function() {

			this.response.links.forEach(function(l) {
				if (l.rel.indexOf('http://api.brightspace.com/rel/theme') > -1) {
					this.themeRequest = document.createElement('iron-request');
					this.themeRequest
						.send({url: l.href, handleAs: 'json'})
						.then(function(res) {
							this.handleThemeResponse(res.response);
						}.bind(this));
				}
			}.bind(this));

			var items = [];
			this.response.entities.forEach(function(e) {
				if (e.class.indexOf('item') > -1) {
					items.push(e);
				}
			});
			this.items = items;

			this.text = this.response.properties.text;

			this.updateLoading();

		},
		handleThemeResponse: function(res) {
			res.entities.forEach(function(e) {
				if (e.class.indexOf('image') > -1) {
					e.links.forEach(function(l) {
						if (l.rel.indexOf('alternate') > -1) {
							this.logoSrc = l.href;
						} else if( l.rel.indexOf('http://api.brightspace.com/rel/home') > -1) {
							this.logoHref = l.href;
						}
					}.bind(this));
				}
			}.bind(this));
			this.themeColor = res.properties.BackgroundColor;
			this.updateLoading();
		},
		load: function() {
			if (this.loading) {
				return;
			}
			this.themeRequest = null;
			this.loading = true;
			this.$$('iron-ajax').generateRequest();
			this.$$('d2l-navigation-page-load-progress').start();
		}
	});
</script>
