<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../iron-ajax/iron-ajax.html">
<link rel="import" href="centerer.html">
<link rel="import" href="page-load-progress.html">
<link rel="import" href="items.html">
<link rel="import" href="logo.html">

<dom-module id="d2l-navigation">

	<style>
		:host {
			background-color: #fff;
			border-bottom: 1px solid #e6eaf0;
			display: block;
			line-height: 1;
			position: relative;
		}
		:host > nav {
			opacity: 0;
			transition: opacity 500ms;
		}
		:host[loaded] > nav {
			opacity: 1;
		}
		hr {
			border-bottom: none;
			border-top: 1px solid #e6eaf0;
			margin: 0;
		}
	</style>

	<template>
		<iron-ajax
			url="{{endpoint}}"
			handle-as="json"
			last-response="{{response}}"
			on-response="handleResponse"></iron-ajax>
		<d2l-navigation-page-load-progress
			color="[[response.properties.color]]"></d2l-navigation-page-load-progress>
		<nav>
			<d2l-navigation-centerer>
				<d2l-navigation-logo data="[[logo]]"></d2l-navigation-logo>
			</d2l-navigation-centerer>
			<hr />
			<d2l-navigation-centerer>
				<d2l-navigation-items items="[[items]]"></d2l-navigation-items>
			</d2l-navigation-centerer>
		</nav>
	</template>

</dom-module>

<script>

	Polymer({
		is: 'd2l-navigation',
		properties: {
			delay: {
				type: Number,
				value: 200
			},
			endpoint: {
				type: String
			},
			loading: {
				type: Boolean,
				value: false
			},
			items: {
				type: Array
			},
			logo: {
				type: Object
			}
		},
		ready: function() {
			this.load();
		},
		handleResponse: function() {

			var logoSrc, logoHref = '';
			var items = [];
			this.response.entities.forEach(function(e) {
				if (e.class.indexOf('image') > -1) {
					e.links.forEach(function(l) {
						if (l.rel.indexOf('alternate') > -1) {
							logoSrc = l.href;
						} else if( l.rel.indexOf('http://api.brightspace.com/rel/home') > -1) {
							logoHref = l.href;
						}
					});
				} else if (e.class.indexOf('item') > -1) {
					items.push(e);
				}
			});

			this.items = items;
			this.logo = {
				href: logoHref,
				text: this.response.properties.text,
				src: logoSrc
			};

			var delay = Math.min(200, this.delay);
			this.async(function() {
				this.setAttribute('loaded', '');
				this.$$('d2l-navigation-page-load-progress').finish();
				this.loading = false;
			}.bind(this), delay)

		},
		load: function() {
			if (this.loading) {
				return;
			}
			this.loading = true;
			this.$$('iron-ajax').generateRequest();
			this.$$('d2l-navigation-page-load-progress').start();
			this.removeAttribute('loaded');
		}
	});

</script>
