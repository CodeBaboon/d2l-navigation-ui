<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../iron-ajax/iron-ajax.html">
<link rel="import" href="../d2l-page-load-progress/d2l-page-load-progress.html">
<link rel="import" href="navigation-resolved.html">
<dom-module id="d2l-navigation">
	<style>
		:host {
			display: block;
			min-width: 320px;
		}
		d2l-navigation-resolved {
			transition: opacity 200ms;
		}
		:host([loading]) d2l-navigation-resolved {
			opacity: 0;
		}
	</style>
	<template>
		<d2l-page-load-progress
			autostart
			color="[[themeColor]]"></d2l-page-load-progress>
		<d2l-navigation-resolved
			band-color="[[themeColor]]"
			items="[[items]]"
			logo="[[logo]]"
			my-home="[[myHome]]"
			org-unit-home="[[orgUnitHome]]"
			org-unit-name="[[orgUnitName]]"
			profile-display-name="[[profileDisplayName]]"
			profile-thumbnail-src="[[profileThumbnailSrc]]"></d2l-navigation-resolved>
	</template>
</dom-module>
<script>
	Polymer({
		is: 'd2l-navigation',
		properties: {
			delay: {
				type: Number,
				value: 200
			},
			endpointNav: String,
			endpointWhoAmI: String,
			isOrg: {
				reflectToAttribute: true,
				type: Boolean,
				value: false
			},
			logo: String,
			loading: {
				reflectToAttribute: true,
				type: Boolean,
				value: false
			},
			items: {
				type: Array,
				value: []
			},
			myHome: String,
			navRequest: Object,
			whoAmIRequest: Object,
			orgUnitName: String,
			orgUnitHome: String,
			showIncomplete: Boolean,
			themeColor: String,
			themeRequest: Object,
			profileDisplayName: String,
			profileThumbnailSrc: String
		},
		updateLoading: function() {
			var finish = function() {
				var delay = Math.max(200, this.delay);
				this.async(function() {
					this.$$('d2l-page-load-progress').finish();
					this.fire('d2l-navigation-ready');
					this.loading = false;
				}.bind(this), delay);
			}.bind(this);

			if(this._checkIfDoneLoading([
				this.navRequest,
				this.themeRequest,
				this.whoAmIRequest
			])) {
				finish();
			}
		},
		_checkIfDoneLoading: function(requests) {
		  requests.forEach(function(request) {
		    if (!request || (request.status != 500 && request.status != 200) ) {
		      return false;
		    }
		  });
		  return true;
		},
		ready: function() {
			this.load(true);
		},
		handleNavResponse: function(res) {

			res.links.forEach(function(l) {
				if (l.rel.indexOf('http://navigation.api.brightspace.com/rels/theme') > -1) {
					this.themeRequest = document.createElement('iron-request');
					this.themeRequest
						.send({url: l.href, handleAs: 'json'})
						.then(function(res) {
							this.handleThemeResponse(res.response);
						}.bind(this))
						.catch(function() {
							this.updateLoading();
						}.bind(this));
				} else if(l.rel.indexOf('http://navigation.api.brightspace.com/rels/my-home') > -1) {
					this.myHome = l.href;
				}
			}.bind(this));

			res.entities.forEach(function(e) {
				if (e.class.indexOf('admin') > -1) {
					// TODO: deal with admin categories/links
				} else if (e.class.indexOf('item') > -1 && e.class.indexOf('group') < 0) {
					this.push('items', e);
				}
			}.bind(this));

			res.actions.forEach(function(a) {
				if (a.name === 'logout') {
					this.push('items', a);
				}
			}.bind(this));

			this.updateLoading();

		},
		handleThemeResponse: function(res) {
			res.entities.forEach(function(e) {
				if (e.class.indexOf('image') > -1) {
					e.links.forEach(function(l) {
						if (l.rel.indexOf('alternate') > -1) {
							this.logo = l.href;
						}
					}.bind(this));
				}
			}.bind(this));
			this.themeColor = res.properties.BackgroundColor;
			this.updateLoading();
		},
		handleWhoAmIResponse: function(res) {
			res.entities.forEach(function(resEntity) {
				if (resEntity.class.indexOf('profile') > -1) {
					resEntity.entities.forEach(function(profileEntity) {
						if (profileEntity.class.indexOf('thumbnail') > -1) {
							profileEntity.entities.forEach(function(imageEntity) {
								if (imageEntity.rel.indexOf('alternate') > -1) {
									this.profileThumbnailSrc = imageEntity.href;
								}
							}.bind(this));
						}
					}.bind(this));
				} else	if (resEntity.class.indexOf('display') > -1) {
					this.profileDisplayName = resEntity.properties.displayname;
				}
			}.bind(this));
			this.updateLoading();
		},
		load: function(firstLoad) {
			if (this.loading) {
				return;
			}
			this.themeRequest = null;
			this.loading = true;
			this.splice('items', 0, this.items.length);
			this.navRequest = document.createElement('iron-request');
			this.navRequest
				.send({url: this.endpointNav, handleAs: 'json'})
				.then(function(res) {
					this.handleNavResponse(res.response);
				}.bind(this))
				.catch(function() {
					this.updateLoading();
				}.bind(this));
			this.whoAmIRequest = document.createElement('iron-request');
			this.whoAmIRequest
				.send({url: this.endpointWhoAmI, handleAs: 'json'})
				.then(function(res) {
					this.handleWhoAmIResponse(res.response);
				}.bind(this))
				.catch(function() {
					this.updateLoading();
				}.bind(this));
			if (!firstLoad) {
				this.$$('d2l-page-load-progress').start();
			}
		}
	});
</script>
