<link rel="import" href="../../polymer/polymer.html">
<link rel="import" href="../../vui-colors/colors.html">
<link rel="import" href="../../d2l-dropdown/dropdown.html">
<link rel="import" href="../button-highlight.html">
<link rel="import" href="../graft-behavior.html">
<dom-module id="d2l-navigation-personal-menu">
	<style>
	:host {
		display: inline-block;
		height: 100%;
	}
	button {
		-webkit-align-items: center;
		-ms-flex-align: center;
		align-items: center;
		display: -ms-flexbox;
		display: -webkit-flex;
		display: flex;
	}
	.d2l-navigation-personal-menu-thumbnail {
		background-repeat: no-repeat;
		background-size: 42px 42px;
		border-radius: 8px;
		display: none;
		-ms-flex: 0 0 auto;
		-webkit-flex: 0 0 auto;
		flex: 0 0 auto;
		margin-right: 10px;
		height: 42px;
		width: 42px;
	}
	.d2l-navigation-personal-menu-text {
		-ms-flex: 0 1 auto;
		-webkit-flex: 0 1 auto;
		flex: 0 1 auto;
		max-width: 200px;
		min-width: 40px;
		overflow: hidden;
		text-overflow: ellipsis;
		white-space: nowrap;
		width: 100%;
	}
	:host-context([dir='rtl']) .d2l-navigation-personal-menu-text {
		margin-left: 0;
		margin-right: 10px;
	}
	d2l-dropdown {
		min-width: 300px;
	}
	@media(max-width: 992px) {
		.d2l-navigation-personal-menu-text {
			display: none;
		}
	}
	</style>
	<template>
		<button
			is="d2l-navigation-button-highlight"
			on-tap="open"
			id="d2l-navigation-personal-menu-opener">
			<span class="d2l-navigation-personal-menu-thumbnail"></span>
			<p class="d2l-navigation-personal-menu-text">[[displayName]]</p>
		</button>
		<d2l-dropdown
			target-id="d2l-navigation-personal-menu-opener"
			on-open="_handleOpen"
			on-close="_handleClose">
			<div id="d2l-navigation-personal-menu-placeholder"></div>
		</d2l-dropdown>
	</template>
</dom-module>
<script>
	Polymer({
		is: 'd2l-navigation-personal-menu',
		properties: {
			userHref: String,
			displayName: String
		},
		behaviors: [window.D2L.PolymerBehaviors.NavigationGraftBehavior],
		open: function() {
			this.$$('d2l-dropdown').setAttribute('opened', 'opened');
			this.graft('d2l-navigation-personal-menu-placeholder');
		},
		ready: function() {
			if (!this.userHref) {
				return;
			}
			document.createElement('iron-request')
				.send({url: this.userHref, handleAs: 'json'})
				.then(function(res) {
					this._handleUserResponse(res.response);
				}.bind(this))
				.catch(function() {
					//to do: do anything?
				}.bind(this));
		},
		_handleUserResponse: function(res) {
			res.entities.forEach(function(resEntity) {
				if (resEntity.class.indexOf('profile') > -1) {
					resEntity.entities.forEach(function(profileEntity) {
						if (profileEntity.class.indexOf('thumbnail') > -1) {
							profileEntity.entities.forEach(function(imageEntity) {
								if ((imageEntity.rel.indexOf('alternate') > -1)) {
									this._setThumbnail(imageEntity.href);
								}
							}.bind(this));
						}
					}.bind(this));
				} else	if (resEntity.class.indexOf('display') > -1) {
					this.displayName = resEntity.properties.name;
				}
			}.bind(this));
			this.updateLoading();
		},
		_setThumbnail: function(url) {
			var thumbnail = this.$$('.d2l-navigation-personal-menu-thumbnail');
			thumbnail.style.backgroundImage = 'url("' + url + '")';
			thumbnail.style.display = 'block';
		},
		_handleOpen: function() {
			var opener = this.$$('#d2l-navigation-personal-menu-opener');
			Polymer.dom(opener).setAttribute('active', 'active');
		},
		_handleClose: function() {
			var opener = this.$$('#d2l-navigation-personal-menu-opener');
			Polymer.dom(opener).removeAttribute('active');
		}
	});
</script>
