<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../d2l-colors/d2l-colors.html">
<link rel="import" href="centerer.html">
<link rel="import" href="item-link.html">
<link rel="import" href="item-group.html">
<link rel="import" href="item-link-behavior.html">
<link rel="import" href="more-group.html">
<dom-module id="d2l-navigation-main">
	<style include="d2l-colors">
		:host {
			border-bottom: 1px solid var(--d2l-color-gypsum);
			display: block;
			height: calc(1rem + 40px);
			overflow: hidden;
		}
		:host([aria-hidden]) {
			bottom: 0;
			display: none;
			left: -10000px;
			position: fixed;
			width: 100%;
		}
		:host([justify-space-between]) .d2l-navigation-main-wrapper {
			-webkit-align-items: center;
			-moz-align-items: center;
			-ms-align-items: center;
			align-items: center;
			display: -webkit-box;
			display: -moz-box;
			display: -ms-flexbox;
			display: -webkit-flex;
			display: flex;
			-webkit-justify-content: space-between;
			-moz-align-justify-content: space-between;
			-ms-align-justify-content: space-between;
			justify-content: space-between;
			-webkit-flex-wrap: nowrap;
			-moz-flex-wrap: nowrap;
			-ms-flex-wrap: nowrap;
			flex-wrap: nowrap;
		}
		:host([debugging]) {
			background-color: orange;
			display: block;
			left: 0;
		}
	</style>
	<template>
	  <d2l-navigation-centerer>
			<div class="d2l-navigation-main-wrapper">
				<template is="dom-repeat" items="[[items]]" on-dom-change="_handleDomChange">
					<template is="dom-if" if="[[isItemGroup(item)]]">
						<d2l-navigation-item-group item=[[item]]></d2l-navigation-item-group>
					</template>
					<template is="dom-if" if="[[isItemLink(item)]]">
						<d2l-navigation-item-link item="[[item]]"></d2l-navigation-item-link>
					</template>
				</template>
				<d2l-navigation-more-group items="[[items]]"></d2l-navigation-more-group>
			</div>
	  </d2l-navigation-centerer>
	</template>
</dom-module>
<script>
	Polymer({
		is: 'd2l-navigation-main',
		properties: {
			items: Array,
			_navItems: Array,
			_moreGroup: Object
		},
		behaviors: [window.D2L.PolymerBehaviors.Navigation.ItemLinkBehavior],
		ready: function() {
			this._moreGroup = this.$$('d2l-navigation-more-group');
		},
		getItemCount: function() {
			return this._navItems.length;
		},
		getItemsShowingCount: function() {
			var result = 0;
			this._navItems.forEach(function(navItem) {
				if (Polymer.dom(navItem).node.style.display !== 'none') {
					result++;
				}
			});
			return result;
		},
		getIsMoreGroupShowing: function() {
			return Polymer.dom(this._moreGroup).node.style.display !== 'none';
		},
		hiddenChomp: function() {
			// todo: if this is aria-hiden ensure it is shown to start
			var navItems = this._navItems,
				navItemsLength = this.getItemCount();

			if (navItemsLength === 0) {
				this.hideMainGroup();
				return undefined;
			}

			this._showAllItems();
			var lastNavItem = navItems[navItemsLength - 1];

			if (this._isOnFirstRow(lastNavItem)) {
				this.hideMainGroup();
				return undefined;
			}

			this.showMainGroup();
			var index = navItemsLength - 1;
			while (!this._isOnFirstRow(this._moreGroup)) {
				this._hideItem(navItems[index]);
				index--;
			}
			// todo: if this is aria-hiden & not debugging? ensure it is hidden again
		},
		showStartingItems: function(numItems) {
			this._navItems.forEach(function(navItem, index) {
				Polymer.dom(navItem).node.style.display =
					(index < numItems) ? 'inline-block' : 'none';
			});
		},
		showMainGroup: function() {
			Polymer.dom(this._moreGroup).node.style.display = 'inline-block';
		},
		hideMainGroup: function() {
			Polymer.dom(this._moreGroup).node.style.display = 'none';
		},
		_isOnFirstRow: function(navItem) {
			var baseOffsetTop = Polymer.dom(this._navItems[0]).node.offsetTop;
			var result = (Polymer.dom(navItem).node.offsetTop === baseOffsetTop);
			return result;
		},
		_showAllItems: function() {
			this._navItems.forEach(function(navItem) {
				Polymer.dom(navItem).node.style.display = 'inline-block';
			});
		},
		_hideItem: function(navItem) {
			Polymer.dom(navItem).node.style.display = 'none';
		},
		_handleDomChange: function() {
			this.async(function() {
				this._navItems = Polymer.dom(this.root).querySelectorAll(
					'd2l-navigation-item-link,d2l-navigation-item-group'
				);
				if (this.getItemCount() > 0) {
					this.fire('d2l-navigation-main-items-available');
				}
			});
		}
	});
</script>
